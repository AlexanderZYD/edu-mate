{% extends "base.html" %}

{% block title %}Forgot Password - EduMate{% endblock %}

{% block content %}
<div class="forgot-password-page py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
                <div class="card shadow-lg">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <i class="fas fa-user-shield fa-3x text-primary mb-3"></i>
                            <h3>Password Recovery</h3>
                            <p class="text-muted">Verify your identity and set a new password</p>
                        </div>
                        
                        <!-- Flash Messages -->
                        {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                                {% for category, message in messages %}
                                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}
                        
                        <form method="POST" action="{{ url_for('auth.forgot_password') }}" id="forgotPasswordForm">
                            <!-- Identity Verification Section -->
                            <div class="mb-4">
                                <h5 class="mb-3">Step 1: Verify Identity</h5>
                                
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email Address</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-envelope"></i>
                                        </span>
                                        <input type="email" class="form-control" id="email" name="email" 
                                               placeholder="your.email@example.com" required autocomplete="off">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="id_number" class="form-label">ID Number</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-id-badge"></i>
                                        </span>
                                        <input type="text" class="form-control" id="id_number" name="id_number" 
                                               placeholder="Enter your ID number" required>
                                    </div>
                                    <small class="form-text text-muted">Your identification number used during registration.</small>
                                </div>
                            </div>
                            
                            <hr class="my-4">
                            
                            <!-- Password Reset Section -->
                            <div class="mb-4">
                                <h5 class="mb-3">Step 2: Set New Password</h5>
                                
                                <div class="mb-3">
                                    <label for="new_password" class="form-label">New Password</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-key"></i>
                                        </span>
                                        <input type="password" class="form-control" id="new_password" name="new_password" 
                                               placeholder="Enter your new password" minlength="6" required>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="confirm_password" class="form-label">Confirm New Password</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-lock"></i>
                                        </span>
                                        <input type="password" class="form-control" id="confirm_password" 
                                               name="confirm_password" placeholder="Confirm your new password" required>
                                    </div>
                                </div>
                                
                                <!-- Password Strength Indicator -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="form-label mb-0">Password Strength:</span>
                                        <span id="strengthText" class="badge bg-secondary">Weak</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div id="strengthBar" class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small class="form-text text-muted">
                                        Use uppercase, lowercase, numbers, and symbols for stronger password.
                                    </small>
                                </div>
                            </div>
                            
                            <div class="d-grid mb-3">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-sync-alt me-2"></i>
                                    Reset Password
                                </button>
                            </div>
                            
                            <div class="text-center">
                                <a href="{{ url_for('auth.login') }}" class="text-decoration-none">
                                    <i class="fas fa-arrow-left me-2"></i>
                                    Back to Login
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('forgotPasswordForm');
    const newPasswordInput = document.getElementById('new_password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const strengthBar = document.getElementById('strengthBar');
    const strengthText = document.getElementById('strengthText');
    
    // Password strength checker
    function checkPasswordStrength(password) {
        let strength = 0;
        const checks = {
            length: password.length >= 8,
            lowercase: /[a-z]/.test(password),
            uppercase: /[A-Z]/.test(password),
            numbers: /[0-9]/.test(password),
            symbols: /[^A-Za-z0-9]/.test(password)
        };
        
        Object.values(checks).forEach(passed => {
            if (passed) strength++;
        });
        
        const percentage = (strength / 5) * 100;
        strengthBar.style.width = percentage + '%';
        
        if (strength <= 2) {
            strengthBar.className = 'progress-bar bg-danger';
            strengthText.textContent = 'Weak';
            strengthText.className = 'badge bg-danger';
        } else if (strength <= 3) {
            strengthBar.className = 'progress-bar bg-warning';
            strengthText.textContent = 'Fair';
            strengthText.className = 'badge bg-warning';
        } else if (strength <= 4) {
            strengthBar.className = 'progress-bar bg-info';
            strengthText.textContent = 'Good';
            strengthText.className = 'badge bg-info';
        } else {
            strengthBar.className = 'progress-bar bg-success';
            strengthText.textContent = 'Strong';
            strengthText.className = 'badge bg-success';
        }
    }
    
    // Real-time password strength checking
    newPasswordInput.addEventListener('input', function() {
        checkPasswordStrength(this.value);
    });
    
    // Clear custom validity when user types in confirm field
    confirmPasswordInput.addEventListener('input', function() {
        if (this.value === newPasswordInput.value) {
            this.setCustomValidity('');
            this.classList.remove('is-invalid');
        } else {
            this.setCustomValidity('Passwords do not match');
        }
    });
    
    // Form submission validation
    form.addEventListener('submit', function(event) {
        // Check if passwords match
        if (newPasswordInput.value !== confirmPasswordInput.value) {
            event.preventDefault();
            event.stopPropagation();
            
            confirmPasswordInput.setCustomValidity('Passwords do not match');
            confirmPasswordInput.classList.add('is-invalid');
            
            alert('Passwords do not match');
            return;
        }
        
        // Check password length
        if (newPasswordInput.value.length < 6) {
            event.preventDefault();
            event.stopPropagation();
            
            alert('Password must be at least 6 characters long');
            return;
        }
        
        // Bootstrap validation
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
            form.classList.add('was-validated');
            return;
        }
        
        // Clear any previous errors
        confirmPasswordInput.setCustomValidity('');
        confirmPasswordInput.classList.remove('is-invalid');
        form.classList.add('was-validated');
        
        // Show loading state on submit button
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Resetting...';
        submitBtn.disabled = true;
    }, false);
});
</script>

<style>
.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.btn-primary:hover {
    background-color: #0b5ed7;
    border-color: #0a58ca;
}

.input-group-text {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
}

.progress {
    background-color: #e9ecef;
    border-radius: 10px;
}

.progress-bar {
    border-radius: 10px;
    transition: all 0.3s ease;
}
</style>
{% endblock %}