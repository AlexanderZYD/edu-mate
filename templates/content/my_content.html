{% extends "base.html" %}

{% block title %}My Content - EduMate{% endblock %}

{% block extra_css %}
<style>
.content-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-left: 4px solid #dee2e6;
}
.content-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.content-card.published {
    border-left-color: #28a745;
}
.content-card.unpublished {
    border-left-color: #dc3545;
    background-color: #fff5f5;
}
.status-badge {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
}
.action-buttons .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}
.stats-row {
    font-size: 0.875rem;
    color: #6c757d;
}
.rating-stars {
    color: #ffc107;
}
.unpublish-btn:hover {
    background-color: #0dcaf0;
    color: white;
}
.direct-publish-btn:hover {
    background-color: #198754;
    color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-folder-open me-2"></i>My Content
        </h2>
        <a href="{{ url_for('content.upload') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Upload New Content
        </a>
    </div>

    {% if content_list %}
        <div class="row">
            {% for content in content_list %}
            <div class="col-lg-6 col-xl-4 mb-4">
                <div class="card content-card {{ 'published' if content.is_published else 'unpublished' }} h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">{{ content.title }}</h6>
                        <span class="badge status-badge {{ 'bg-success' if content.is_published else 'bg-danger' }}">
                            {{ 'Published' if content.is_published else 'Hidden' }}
                        </span>
                    </div>
                    
                    <div class="card-body">
                        <p class="card-text text-muted small">{{ content.description[:100] }}{% if content.description|length > 100 %}...{% endif %}</p>
                        
                        <div class="stats-row mb-3">
                            <div class="row">
                                <div class="col-6">
                                    <i class="fas fa-eye me-1"></i> {{ content.view_count or 0 }} views
                                </div>
                                <div class="col-6">
                                    <i class="fas fa-download me-1"></i> {{ content.download_count or 0 }} downloads
                                </div>
                                <div class="col-6">
                                    <i class="fas fa-comment me-1"></i> {{ content.feedback_count or 0 }} feedback
                                </div>
                                <div class="col-6">
                                    {% if content.avg_rating %}
                                    <span class="rating-stars">
                                        {% for i in range(content.avg_rating|round|int) %}
                                        <i class="fas fa-star"></i>
                                        {% endfor %}
                                        {% if content.avg_rating|round|int < 5 %}
                                            {% for i in range(5 - content.avg_rating|round|int) %}
                                            <i class="far fa-star"></i>
                                            {% endfor %}
                                        {% endif %}
                                        {{ content.avg_rating|round(1) }}
                                    </span>
                                    {% else %}
                                    <i class="far fa-star me-1"></i> No rating
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-tag me-1"></i> {{ content.category_name or 'Uncategorized' }}
                                <span class="mx-2">|</span>
                                <i class="fas fa-layer-group me-1"></i> {{ content.type.title() }}
                                <span class="mx-2">|</span>
                                <i class="fas fa-signal me-1"></i> {{ content.difficulty_level.title() }}
                            </small>
                        </div>

                        <div class="action-buttons">
                            <div class="btn-group w-100" role="group">
                                <a href="{{ url_for('content.view', content_id=content.id) }}" 
                                   class="btn btn-outline-primary">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                <a href="{{ url_for('content.edit', content_id=content.id) }}" 
                                   class="btn btn-outline-secondary">
                                    <i class="fas fa-edit"></i> Edit
                                </a>
                                {% if not content.is_published %}
                                    {% if session.user_role == 'admin' %}
                                    <button class="btn btn-outline-success direct-publish-btn" 
                                            data-content-id="{{ content.id }}" 
                                            data-title="{{ content.title }}">
                                        <i class="fas fa-check"></i> Publish
                                    </button>
                                    {% else %}
                                    <button class="btn btn-outline-warning request-publish-btn" 
                                            data-content-id="{{ content.id }}" 
                                            data-title="{{ content.title }}">
                                        <i class="fas fa-paper-plane"></i> Request Publish
                                    </button>
                                    {% endif %}
                                {% else %}
                                <button class="btn btn-outline-info unpublish-btn" 
                                        data-content-id="{{ content.id }}" 
                                        data-title="{{ content.title }}">
                                    <i class="fas fa-eye-slash"></i> Unpublish
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-danger delete-btn" 
                                        data-content-id="{{ content.id }}" 
                                        data-title="{{ content.title }}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-5">
            <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">You haven't uploaded any content yet</h4>
            <p class="text-muted">Start sharing your knowledge by uploading your first learning material.</p>
            <a href="{{ url_for('content.upload') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Upload Your First Content
            </a>
        </div>
    {% endif %}
</div>

<!-- Request Publish Modal -->
<div class="modal fade" id="requestPublishModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Request Content Publication</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Send a message to administrators requesting to republish this content:</p>
                <div class="mb-3">
                    <label for="requestReason" class="form-label">Reason for republication request:</label>
                    <textarea class="form-control" id="requestReason" rows="4" 
                              placeholder="Please explain why this content should be republished and any changes you've made..."></textarea>
                    <div class="d-flex justify-content-between align-items-center mt-1">
                        <small class="text-muted">Providing a reason helps administrators review your request faster.</small>
                        <small class="text-muted">Leave empty to submit with default reason</small>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="requestContent" class="form-label">Additional message (optional):</label>
                    <textarea class="form-control" id="requestContent" rows="3" 
                              placeholder="Any additional information for administrators..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendRequestBtn">
                    <i class="fas fa-paper-plane"></i> Send Request
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Delete content - Use event delegation to avoid conflicts
document.addEventListener('click', function(e) {
    // Check if the clicked element is a delete button within content cards
    const deleteBtn = e.target.closest('.delete-btn');
    if (!deleteBtn || !deleteBtn.closest('.content-card')) {
        return;
    }
    
    e.preventDefault();
    e.stopPropagation();
    
    const contentId = deleteBtn.dataset.contentId;
    const title = deleteBtn.dataset.title;
    
    // Remove any existing modals
    const existingModal = document.getElementById('deleteConfirmModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Create confirmation modal
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'deleteConfirmModal';
        modal.setAttribute('tabindex', '-1');
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirm Delete</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete "<strong>${title}</strong>"?</p>
                        <p class="text-danger">This action cannot be undone and will permanently remove all associated data.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                            <i class="fas fa-trash me-2"></i>Delete Content
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Show modal
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();
        
        // Handle confirm delete
        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            modalInstance.hide();
            
            // Disable the delete button to prevent multiple clicks
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deleting...';
            
            fetch(`/content/${contentId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Content deleted successfully', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showNotification('Error deleting content: ' + data.error, 'error');
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
                }
            })
            .catch(error => {
                showNotification('Error deleting content', 'error');
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
            });
        });
        
        // Clean up modal when hidden
        modal.addEventListener('hidden.bs.modal', function() {
            modal.remove();
        });
});

// Handle unpublish button clicks
document.addEventListener('click', function(e) {
    const unpublishBtn = e.target.closest('.unpublish-btn');
    if (!unpublishBtn || !unpublishBtn.closest('.content-card')) {
        return;
    }
    
    e.preventDefault();
    e.stopPropagation();
    
    const contentId = unpublishBtn.dataset.contentId;
    const title = unpublishBtn.dataset.title;
    
    // Remove any existing modals
    const existingModal = document.getElementById('unpublishConfirmModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Create confirmation modal
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'unpublishConfirmModal';
    modal.setAttribute('tabindex', '-1');
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Unpublish</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to unpublish "<strong>${title}</strong>"?</p>
                    <p class="text-warning">This content will no longer be visible to students after unpublishing.</p>
                    <p>You can always request to republish it later.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info" id="confirmUnpublishBtn">
                        <i class="fas fa-eye-slash me-2"></i>Unpublish Content
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Show modal
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    
    // Handle confirm unpublish
    document.getElementById('confirmUnpublishBtn').addEventListener('click', function() {
        modalInstance.hide();
        
        // Disable the unpublish button to prevent multiple clicks
        unpublishBtn.disabled = true;
        unpublishBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Unpublishing...';
        
        fetch(`/content/${contentId}/unpublish`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Content unpublished successfully', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showNotification('Error unpublishing content: ' + data.error, 'error');
                unpublishBtn.disabled = false;
                unpublishBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Unpublish';
            }
        })
        .catch(error => {
            showNotification('Error unpublishing content', 'error');
            unpublishBtn.disabled = false;
            unpublishBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Unpublish';
        });
    });
    
    // Clean up modal when hidden
    modal.addEventListener('hidden.bs.modal', function() {
        modal.remove();
    });
});

// Handle direct publish button clicks (for admins)
document.addEventListener('click', function(e) {
    const publishBtn = e.target.closest('.direct-publish-btn');
    if (!publishBtn || !publishBtn.closest('.content-card')) {
        return;
    }
    
    e.preventDefault();
    e.stopPropagation();
    
    const contentId = publishBtn.dataset.contentId;
    const title = publishBtn.dataset.title;
    
    // Remove any existing modals
    const existingModal = document.getElementById('directPublishConfirmModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Create confirmation modal
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'directPublishConfirmModal';
    modal.setAttribute('tabindex', '-1');
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Publish</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to publish "<strong>${title}</strong>"?</p>
                    <p class="text-success">This content will be immediately visible to all users.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="confirmDirectPublishBtn">
                        <i class="fas fa-check me-2"></i>Publish Content
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Show modal
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    
    // Handle confirm publish
    document.getElementById('confirmDirectPublishBtn').addEventListener('click', function() {
        modalInstance.hide();
        
        // Disable the publish button to prevent multiple clicks
        publishBtn.disabled = true;
        publishBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Publishing...';
        
        fetch(`/content/${contentId}/publish`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Content published successfully', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showNotification('Error publishing content: ' + data.error, 'error');
                publishBtn.disabled = false;
                publishBtn.innerHTML = '<i class="fas fa-check"></i> Publish';
            }
        })
        .catch(error => {
            showNotification('Error publishing content', 'error');
            publishBtn.disabled = false;
            publishBtn.innerHTML = '<i class="fas fa-check"></i> Publish';
        });
    });
    
    // Clean up modal when hidden
    modal.addEventListener('hidden.bs.modal', function() {
        modal.remove();
    });
});

// Request publish
let currentContentId = null;
let currentContentTitle = null;

document.querySelectorAll('.request-publish-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        currentContentId = this.dataset.contentId;
        currentContentTitle = this.dataset.title;
        
        // Check if request already exists for this content
        fetch(`/messages/check-publication-request/${currentContentId}`)
        .then(response => response.json())
        .then(data => {
            if (data.exists) {
                showNotification('You have already submitted a publication request for this content. Please wait for admin review.', 'warning');
                return;
            }
            
            // Set title in modal
            document.querySelector('#requestPublishModal .modal-title').textContent = 
                `Request Publication: ${currentContentTitle}`;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('requestPublishModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error checking publication request:', error);
            // Still show modal if check fails
            document.querySelector('#requestPublishModal .modal-title').textContent = 
                `Request Publication: ${currentContentTitle}`;
            const modal = new bootstrap.Modal(document.getElementById('requestPublishModal'));
            modal.show();
        });
    });
});

// Send publication request
document.getElementById('sendRequestBtn').addEventListener('click', function() {
    const reason = document.getElementById('requestReason').value.trim();
    const additionalMessage = document.getElementById('requestContent').value.trim();
    const sendBtn = this;
    const originalText = sendBtn.innerHTML;
    
    // Add loading state
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
    
    // Reason is optional, but show confirmation if empty
    let finalReason = reason;
    if (!reason) {
        finalReason = "Request to review content for publication.";
    }
    
    // Send message to admin (user_id=1)
    const messageContent = `
Content Publication Request

Content: ${currentContentTitle}
Content ID: ${currentContentId}
Requested by: {{ session.full_name }} ({{ session.username }})

Reason for republication:
${reason}

${additionalMessage ? 'Additional message:\n' + additionalMessage : ''}

Please review this content and consider republishing it.

Best regards,
Content Author
    `.trim();
    
    fetch('/messages/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            receiver_id: 1, // Admin user
            subject: `Content Publication Request: ${currentContentTitle}`,
            content: messageContent,
            related_content_id: currentContentId
        })
    })
    .then(response => response.json())
    .then(data => {
        // Reset button state
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalText;
        
        if (data.success) {
            if (!reason) {
                showNotification('Request submitted with default reason. Next time, consider adding details to speed up approval!', 'info');
            } else {
                showNotification('Publication request sent successfully!', 'success');
            }
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('requestPublishModal'));
            modal.hide();
            
            // Clear form
            document.getElementById('requestReason').value = '';
            document.getElementById('requestContent').value = '';
        } else {
            // Special handling for duplicate request error
            if (data.error && data.error.includes('already sent a publication request')) {
                showNotification('You have already submitted a publication request for this content. Please wait for admin review before submitting again.', 'warning');
            } else {
                showNotification('Error sending request: ' + data.error, 'error');
            }
        }
    })
    .catch(error => {
        // Reset button state on error
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalText;
        showNotification('Error sending request', 'error');
    });
});
</script>
{% endblock %}